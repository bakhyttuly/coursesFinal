<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <changeSet id="1" author="assistant">

        <createTable tableName="t_permissions">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="permission" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="t_users">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="full_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="t_users_roles">
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="roles_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="t_users_roles"
                baseColumnNames="user_id"
                referencedTableName="t_users"
                referencedColumnNames="id"
                constraintName="fk_users_roles_user"/>

        <addForeignKeyConstraint
                baseTableName="t_users_roles"
                baseColumnNames="roles_id"
                referencedTableName="t_permissions"
                referencedColumnNames="id"
                constraintName="fk_users_roles_role"/>

        <createTable tableName="t_courses">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="level" type="VARCHAR(100)"/>
            <column name="price" type="DOUBLE PRECISION"/>
            <column name="instructor_id" type="BIGINT"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="t_courses"
                baseColumnNames="instructor_id"
                referencedTableName="t_users"
                referencedColumnNames="id"
                constraintName="fk_courses_instructor"/>

        <createTable tableName="t_lessons">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="course_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="TEXT"/>
            <column name="video_url" type="VARCHAR(500)"/>
            <column name="lesson_order" type="INTEGER"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="t_lessons"
                baseColumnNames="course_id"
                referencedTableName="t_courses"
                referencedColumnNames="id"
                constraintName="fk_lessons_course"/>

        <createTable tableName="t_enrollments">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="course_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="enrollment_date" type="VARCHAR(50)"/>
            <column name="status" type="VARCHAR(50)"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="t_enrollments"
                baseColumnNames="user_id"
                referencedTableName="t_users"
                referencedColumnNames="id"
                constraintName="fk_enrollments_user"/>

        <addForeignKeyConstraint
                baseTableName="t_enrollments"
                baseColumnNames="course_id"
                referencedTableName="t_courses"
                referencedColumnNames="id"
                constraintName="fk_enrollments_course"/>

        <addUniqueConstraint
                tableName="t_enrollments"
                columnNames="user_id, course_id"
                constraintName="uq_enrollments_user_course"/>

    </changeSet>

</databaseChangeLog>
